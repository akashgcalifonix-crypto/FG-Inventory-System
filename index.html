<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FG Inventory Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .hidden { display: none; }
    .nav-link { cursor: pointer; font-weight: 500; }
    .nav-link.active { background-color: #0d6efd !important; color: white !important; }
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; color: #0d6efd;}
    .floor-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 12px; color: white; margin-left: 10px; font-weight: bold; }
    .bg-f1 { background-color: #28a745; } .bg-f2 { background-color: #ffc107; color: black; } .bg-base { background-color: #dc3545; }
    .logo-container { text-align: center; margin-bottom: 20px; }
    .logo-img { max-height: 80px; width: auto; }
    /* Queue Table Styles */
    .queue-table th { background-color: #e9ecef; font-size: 0.9em; }
    .queue-table td { font-size: 0.9em; vertical-align: middle; }
  </style>
</head>
<body>

<div id="loader" class="loading-overlay hidden">Processing...</div>

<div class="container bg-white p-4 rounded shadow" style="max-width: 1100px;">
  
  <div class="logo-container"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo" class="logo-img"></div>
  <h3 class="text-center text-primary mb-4 fw-bold">FG Inventory Management System</h3>

  <ul class="nav nav-tabs nav-justified mb-4 shadow-sm rounded">
    <li class="nav-item"><a class="nav-link active" onclick="showTab('prod')">Production</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('pdi')">PDI Tracker</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('disp')">Dispatch</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('open')">Opening</a></li>
    <li class="nav-item"><a class="nav-link text-dark bg-light border-start" onclick="showTab('dash1')">ðŸ“Š Line Dash</a></li>
    <li class="nav-item"><a class="nav-link text-dark bg-light" onclick="showTab('dash2')">ðŸ“ˆ Master Dash</a></li>
  </ul>

  <!-- 1. PRODUCTION TAB -->
  <div id="prod" class="tab-pane">
    <div class="card p-3 border-0">
      <h5 class="text-secondary">Production Entry</h5>
      <form id="form-prod">
        <div class="row g-3">
          <div class="col-md-3"><label class="form-label">Date</label><input type="date" name="date" class="form-control" required></div>
          <div class="col-md-3">
            <label class="form-label">Line (1-24)</label>
            <input type="number" name="line" class="form-control" min="1" max="24" oninput="checkFloor(this, 'bdg-p')" required>
            <span id="bdg-p" class="floor-badge hidden"></span>
          </div>
          <div class="col-md-3"><label class="form-label">Model</label><select name="model" id="prod-m" class="form-select" onchange="filterC('prod')" required></select></div>
          <div class="col-md-3"><label class="form-label">Color</label><select name="color" id="prod-c" class="form-select" onchange="fillP('prod')" required></select></div>
          <div class="col-md-6"><label class="form-label">boAt Part Code</label><input type="text" name="partCode" id="prod-p" class="form-control bg-light" readonly></div>
          <div class="col-md-6"><label class="form-label">FG Output (Qty)</label><input type="number" name="fgQty" class="form-control" required></div>
        </div>
        <button type="button" class="btn btn-warning mt-3 w-100 fw-bold" onclick="addQueue('prod')">+ Add to List</button>
      </form>
      
      <!-- Queue Table -->
      <div class="mt-4">
        <h6>Pending Entries (Click Save to Upload)</h6>
        <table class="table table-bordered table-sm queue-table">
          <thead><tr><th>Date</th><th>Line</th><th>Model</th><th>Color</th><th>Qty</th><th>Action</th></tr></thead>
          <tbody id="queue-prod"></tbody>
        </table>
        <button class="btn btn-primary w-100 fw-bold" onclick="submitQueue('prod', 'Production')">Save All to Google Sheet</button>
      </div>
    </div>
  </div>

  <!-- 2. PDI TAB -->
  <div id="pdi" class="tab-pane hidden">
    <div class="card p-3 border-0">
      <h5 class="text-secondary">PDI Tracker</h5>
      <form id="form-pdi">
        <div class="row g-3">
          <div class="col-md-3"><label class="form-label">Date</label><input type="date" name="date" class="form-control" required></div>
          <div class="col-md-3"><label class="form-label">Line</label><input type="number" name="line" class="form-control" min="1" max="24" oninput="checkFloor(this, 'bdg-d')" required><span id="bdg-d" class="floor-badge hidden"></span></div>
          <div class="col-md-3"><label class="form-label">Model</label><select name="model" id="pdi-m" class="form-select" onchange="filterC('pdi')" required></select></div>
          <div class="col-md-3"><label class="form-label">Color</label><select name="color" id="pdi-c" class="form-select" onchange="fillP('pdi')" required></select></div>
          <div class="col-md-4"><label class="form-label">Part Code</label><input type="text" name="partCode" id="pdi-p" class="form-control bg-light" readonly></div>
          <div class="col-md-4"><label class="form-label">Lot ID</label><input type="text" name="lotId" class="form-control"></div>
          <div class="col-md-4"><label class="form-label">Lot Type</label><select name="lotType" class="form-select"><option>Fresh</option><option>Rework</option><option>Warranty</option><option>Old FG</option><option>Market Return</option></select></div>
          <div class="col-md-4"><label class="form-label">PDI Offer</label><input type="number" id="off" name="pdiOffer" class="form-control" oninput="calcP()" required></div>
          <div class="col-md-4"><label class="form-label">PDI Pass</label><input type="number" id="pas" name="pdiPass" class="form-control" oninput="calcP()" required></div>
          <div class="col-md-4"><label class="form-label">Fail Qty</label><input type="text" id="fal" class="form-control" readonly></div>
          <div id="defBox" class="col-12 hidden"><div class="alert alert-danger"><label class="form-label">Reason:</label><input type="text" name="defectReason" class="form-control"></div></div>
        </div>
        <button type="button" class="btn btn-warning mt-3 w-100 fw-bold" onclick="addQueue('pdi')">+ Add to List</button>
      </form>
      
      <div class="mt-4">
        <h6>Pending PDI Entries</h6>
        <table class="table table-bordered table-sm queue-table">
          <thead><tr><th>Line</th><th>Model</th><th>Color</th><th>Lot</th><th>Pass/Fail</th><th>Action</th></tr></thead>
          <tbody id="queue-pdi"></tbody>
        </table>
        <button class="btn btn-primary w-100 fw-bold" onclick="submitQueue('pdi', 'PDI')">Save All PDI Data</button>
      </div>
    </div>
  </div>

  <!-- 3. DISPATCH TAB -->
  <div id="disp" class="tab-pane hidden">
    <div class="card p-3 border-0">
      <h5 class="text-secondary">Dispatch Entry</h5>
      <form id="form-disp">
        <div class="row g-3">
          <div class="col-md-3"><label class="form-label">Date</label><input type="date" name="date" class="form-control" required></div>
          <div class="col-md-3"><label class="form-label">Model</label><select name="model" id="disp-m" class="form-select" onchange="filterC('disp')" required></select></div>
          <div class="col-md-3"><label class="form-label">Color</label><select name="color" id="disp-c" class="form-select" onchange="fillP('disp')" required></select></div>
          <div class="col-md-3"><label class="form-label">Part Code</label><input type="text" name="partCode" id="disp-p" class="form-control bg-light" readonly></div>
          <div class="col-12"><label class="form-label">Dispatch Qty</label><input type="number" name="dispatchQty" class="form-control" required></div>
        </div>
        <button type="button" class="btn btn-warning mt-3 w-100 fw-bold" onclick="addQueue('disp')">+ Add to List</button>
      </form>
      
      <div class="mt-4">
        <h6>Pending Dispatch Entries</h6>
        <table class="table table-bordered table-sm queue-table">
          <thead><tr><th>Date</th><th>Model</th><th>Color</th><th>Qty</th><th>Action</th></tr></thead>
          <tbody id="queue-disp"></tbody>
        </table>
        <button class="btn btn-success w-100 fw-bold" onclick="submitQueue('disp', 'Dispatch')">Save All Dispatch</button>
      </div>
    </div>
  </div>

  <!-- 4. OPENING TAB -->
  <div id="open" class="tab-pane hidden">
    <div class="card p-3 border-info">
      <h5 class="text-info">Opening Balance (Add Multiple)</h5>
      <form id="form-open">
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label">Month</label><input type="month" name="month" class="form-control" required></div>
          <div class="col-md-4"><label class="form-label">Type</label><select name="openType" class="form-select" onchange="toggleOp(this.value)"><option value="PDI">PDI Opening</option><option value="Dispatch">Dispatch Opening</option></select></div>
          <div class="col-md-4"><label class="form-label">Model</label><select name="model" id="open-m" class="form-select" onchange="filterC('open')" required></select></div>
          <div class="col-md-6"><label class="form-label">Color</label><select name="color" id="open-c" class="form-select" onchange="fillP('open')" required></select></div>
          <div class="col-md-6"><label class="form-label">Part Code</label><input type="text" name="partCode" id="open-p" class="form-control bg-light" readonly></div>
          
          <div class="grp-pdi col-md-3"><label class="form-label">Line</label><input type="number" name="line" class="form-control" min="1" max="24"></div>
          <div class="grp-pdi col-md-3"><label class="form-label">For PDI Open</label><input type="number" name="pdiOpenQty" class="form-control"></div>
          <div class="grp-pdi col-md-3"><label class="form-label">For Rework Open</label><input type="number" name="reworkOpenQty" class="form-control"></div>
          <div class="grp-pdi col-12"><label class="form-label">Rework Reason</label><input type="text" name="reworkReason" class="form-control"></div>
          <div class="grp-disp col-12 hidden"><label class="form-label">Dispatch Open Qty</label><input type="number" name="dispatchOpenQty" class="form-control"></div>
        </div>
        <button type="button" class="btn btn-info mt-3 w-100 fw-bold text-white" onclick="addQueue('open')">+ Add to List</button>
      </form>
      
      <div class="mt-4">
        <h6>Pending Opening Entries</h6>
        <table class="table table-bordered table-sm queue-table">
          <thead><tr><th>Type</th><th>Model</th><th>Color</th><th>Qty</th><th>Action</th></tr></thead>
          <tbody id="queue-open"></tbody>
        </table>
        <button class="btn btn-dark w-100 fw-bold" onclick="submitQueue('open', 'Opening')">Save All Opening Data</button>
      </div>
    </div>
  </div>

  <!-- DASHBOARDS (Same as before) -->
  <div id="dash1" class="tab-pane hidden">
    <div class="input-group mb-3"><span class="input-group-text">Line No</span><input type="number" id="dashLine" class="form-control"><button class="btn btn-dark" onclick="renderDash1()">Show</button></div>
    <div id="dash1-res"></div>
  </div>
  <div id="dash2" class="tab-pane hidden">
    <button class="btn btn-outline-dark btn-sm mb-2" onclick="renderDash2()">Refresh Master</button>
    <div class="table-responsive"><table class="table table-bordered table-sm table-striped"><thead class="table-dark"><tr><th>Model</th><th>Color</th><th>Part</th><th>Opn(Disp)</th><th>FG Out</th><th>PDI Pass</th><th>Disp</th><th>Bal(PDI)</th><th>Bal(Disp)</th></tr></thead><tbody id="master-body"></tbody></table></div>
  </div>

</div>

<script>
  // **********************************************
  // PASTE YOUR NEW WEB APP URL HERE
  const SCRIPT_URL = "PASTE_YOUR_WEB_APP_URL_HERE"; 
  // **********************************************

  let masterData = [];
  let dashboardData = {};
  let queueData = { prod: [], pdi: [], disp: [], open: [] };

  function toggleLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }

  window.onload = function() {
    toggleLoader(true);
    fetch(SCRIPT_URL + "?action=getMasters")
      .then(r => r.json()).then(d => { masterData = d; populateModels(['prod','pdi','disp','open']); toggleLoader(false); })
      .catch(e => { alert("Connection Failed. Check URL."); toggleLoader(false); });
  };

  function showTab(id) {
    document.querySelectorAll('.tab-pane').forEach(e => e.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
  }

  // --- QUEUE LOGIC ---
  function addQueue(tab) {
    let form = document.getElementById('form-' + tab);
    if(!form.checkValidity()) { form.reportValidity(); return; }
    
    let formData = Object.fromEntries(new FormData(form));
    queueData[tab].push(formData);
    renderQueue(tab);
    
    // Clear numeric/text fields only (Keep Date/Line/Model for ease)
    form.querySelectorAll('input[type="number"], input[type="text"]').forEach(i => {
       if(i.name !== 'line' && i.name !== 'month') i.value = "";
    });
  }

  function renderQueue(tab) {
    let tbody = document.getElementById('queue-' + tab);
    tbody.innerHTML = "";
    queueData[tab].forEach((item, index) => {
       let row = "";
       if(tab=='prod') row = `<td>${item.date}</td><td>${item.line}</td><td>${item.model}</td><td>${item.color}</td><td>${item.fgQty}</td>`;
       if(tab=='pdi') row = `<td>${item.line}</td><td>${item.model}</td><td>${item.color}</td><td>${item.lotType}</td><td>${item.pdiPass}/${item.pdiOffer}</td>`;
       if(tab=='disp') row = `<td>${item.date}</td><td>${item.model}</td><td>${item.color}</td><td>${item.dispatchQty}</td>`;
       if(tab=='open') row = `<td>${item.openType}</td><td>${item.model}</td><td>${item.color}</td><td>${item.openType=='PDI'?item.pdiOpenQty:item.dispatchOpenQty}</td>`;
       
       tbody.innerHTML += `<tr>${row}<td><button class="btn btn-sm btn-danger" onclick="removeQueue('${tab}', ${index})">X</button></td></tr>`;
    });
  }

  function removeQueue(tab, index) {
    queueData[tab].splice(index, 1);
    renderQueue(tab);
  }

  function submitQueue(tab, type) {
    if(queueData[tab].length === 0) return alert("List is empty! Add data first.");
    if(SCRIPT_URL.includes("PASTE_YOUR")) return alert("Update SCRIPT_URL!");

    toggleLoader(true);
    fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ type: type, data: queueData[tab] })
    })
    .then(r => r.json())
    .then(d => {
      toggleLoader(false);
      alert(d.message);
      if(d.status === 'success') {
         queueData[tab] = [];
         renderQueue(tab);
         document.getElementById('form-' + tab).reset();
      }
    })
    .catch(e => { toggleLoader(false); alert("Error: " + e); });
  }

  // --- HELPERS ---
  function checkFloor(i,id){ let v=parseInt(i.value),e=document.getElementById(id); e.className="floor-badge"; if(v>=1&&v<=8){e.innerText="1st";e.classList.add("bg-f1");}else if(v>=9&&v<=16){e.innerText="2nd";e.classList.add("bg-f2");}else if(v>=17&&v<=24){e.innerText="Base";e.classList.add("bg-base");}else e.classList.add("hidden"); }
  function populateModels(ids){ let m=[...new Set(masterData.map(r=>r[1]))].sort(); ids.forEach(x=>{ let s=document.getElementById(x+'-m'); s.innerHTML='<option value="">Select Model</option>'; m.forEach(v=>s.innerHTML+=`<option value="${v}">${v}</option>`) }); }
  function filterC(p){ let m=document.getElementById(p+'-m').value,s=document.getElementById(p+'-c'); s.innerHTML='<option value="">Select Color</option>'; [...new Set(masterData.filter(r=>r[1]==m).map(r=>r[2]))].sort().forEach(c=>s.innerHTML+=`<option value="${c}">${c}</option>`); document.getElementById(p+'-p').value=""; }
  function fillP(p){ let m=document.getElementById(p+'-m').value,c=document.getElementById(p+'-c').value,f=masterData.find(r=>r[1]==m&&r[2]==c); if(f)document.getElementById(p+'-p').value=f[0]; }
  function calcP(){ let f=(document.getElementById('off').value||0)-(document.getElementById('pas').value||0); document.getElementById('fal').value=f; document.getElementById('defBox').classList.toggle('hidden',f<=0); }
  function toggleOp(v){ document.querySelectorAll('.grp-pdi').forEach(e=>e.classList.toggle('hidden',v!='PDI')); document.querySelector('.grp-disp').classList.toggle('hidden',v!='Dispatch'); }

  // --- DASHBOARDS ---
  function renderDash1() {
     let line = document.getElementById('dashLine').value; if(!line) return alert("Enter Line");
     toggleLoader(true);
     fetch(SCRIPT_URL+"?action=getDashboard").then(r=>r.json()).then(d=>{
        toggleLoader(false);
        let map={}; const k=(m,c,p)=>m+"|"+c+"|"+p;
        d.prod.filter(r=>r[1]==line).forEach(r=>{ let key=k(r[3],r[4],r[5]); if(!map[key])map[key]={m:r[3],c:r[4],p:r[5],fg:0,oPdi:0,oRew:0,pass:0,fail:0,rewPass:0,rsn:""}; map[key].fg+=Number(r[6]||0); });
        d.pdi.filter(r=>r[1]==line).forEach(r=>{ let key=k(r[3],r[4],r[5]); if(!map[key])map[key]={m:r[3],c:r[4],p:r[5],fg:0,oPdi:0,oRew:0,pass:0,fail:0,rewPass:0,rsn:""}; map[key].pass+=Number(r[9]||0); map[key].fail+=Number(r[10]||0); if(r[11])map[key].rsn=r[11]; if(r[7]=='Rework'||r[7]=='Old FG')map[key].rewPass+=Number(r[9]||0); });
        d.open.filter(r=>r[2]==line&&r[1]=='PDI').forEach(r=>{ let key=k(r[3],r[4],r[5]); if(!map[key])map[key]={m:r[3],c:r[4],p:r[5],fg:0,oPdi:0,oRew:0,pass:0,fail:0,rewPass:0,rsn:r[8]}; map[key].oPdi+=Number(r[6]||0); map[key].oRew+=Number(r[7]||0); });

        let h='<table class="table table-bordered"><thead><tr class="table-secondary"><th>Model</th><th>Color</th><th>Open PDI</th><th>FG Out</th><th>Pass</th><th>Bal PDI</th><th>For Rework</th><th>Reason</th></tr></thead><tbody>';
        for(let x in map){ let o=map[x], bPdi=(o.oPdi+o.fg)-o.pass, bRew=o.oRew+o.fail-o.rewPass; h+=`<tr><td>${o.m}</td><td>${o.c}</td><td>${o.oPdi}</td><td>${o.fg}</td><td>${o.pass}</td><td class="bg-light fw-bold">${bPdi}</td><td class="text-danger fw-bold">${bRew}</td><td>${bRew>0?o.rsn:''}</td></tr>`; }
        document.getElementById('dash1-res').innerHTML=h+'</tbody></table>';
     });
  }
  function renderDash2() {
     toggleLoader(true);
     fetch(SCRIPT_URL+"?action=getDashboard").then(r=>r.json()).then(d=>{
        toggleLoader(false);
        let map={}; const get=(m,c,p)=>{let k=m+c; if(!map[k])map[k]={m,c,p,od:0,fg:0,pass:0,disp:0}; return map[k];};
        d.open.filter(r=>r[1]=='Dispatch').forEach(r=>get(r[3],r[4],r[5]).od+=Number(r[9]||0));
        d.prod.forEach(r=>get(r[3],r[4],r[5]).fg+=Number(r[6]||0));
        d.pdi.forEach(r=>get(r[3],r[4],r[5]).pass+=Number(r[9]||0));
        d.disp.forEach(r=>get(r[1],r[2],r[3]).disp+=Number(r[4]||0));
        let h=''; for(let k in map){ let o=map[k],bPdi=o.fg-o.pass,bDsp=(o.od+o.pass)-o.disp; h+=`<tr><td>${o.m}</td><td>${o.c}</td><td>${o.p}</td><td>${o.od}</td><td>${o.fg}</td><td>${o.pass}</td><td>${o.disp}</td><td>${bPdi}</td><td>${bDsp}</td></tr>`; }
        document.getElementById('master-body').innerHTML=h;
     });
  }
</script>

</body>
</html>
