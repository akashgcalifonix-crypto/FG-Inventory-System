<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FG Inventory Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; padding: 20px; font-family: sans-serif; }
    .hidden { display: none; }
    .nav-link { cursor: pointer; }
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold;}
    .floor-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; color: white; margin-left: 10px; font-weight: bold;}
    .bg-f1 { background-color: #28a745; }
    .bg-f2 { background-color: #ffc107; color: black; }
    .bg-base { background-color: #dc3545; }
  </style>
</head>
<body>

<!-- Loader -->
<div id="loader" class="loading-overlay">Loading Data...</div>

<div class="container bg-white p-4 rounded shadow" style="max-width: 1000px;">
  <h3 class="text-center text-primary mb-4">FG Inventory System (GitHub Host)</h3>

  <!-- TABS -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" onclick="showTab('prod')">Production</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('pdi')">PDI Tracker</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('disp')">Dispatch</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showTab('open')">Opening</a></li>
    <li class="nav-item"><a class="nav-link text-dark fw-bold" onclick="showTab('dash1')">Line Dashboard</a></li>
    <li class="nav-item"><a class="nav-link text-dark fw-bold" onclick="showTab('dash2')">Master Dashboard</a></li>
  </ul>

  <!-- 1. PRODUCTION -->
  <div id="prod" class="tab-pane">
    <form onsubmit="saveData(event, 'Production')">
      <div class="row g-3">
        <div class="col-md-3"><label>Date</label><input type="date" name="date" class="form-control" required></div>
        <div class="col-md-3">
          <label>Line (1-24)</label>
          <input type="number" name="line" class="form-control" min="1" max="24" oninput="checkFloor(this, 'bdg-p')" required>
          <span id="bdg-p" class="floor-badge hidden"></span>
        </div>
        <div class="col-md-3"><label>Model</label><select name="model" id="prod-m" class="form-select" onchange="filterC('prod')" required></select></div>
        <div class="col-md-3"><label>Color</label><select name="color" id="prod-c" class="form-select" onchange="fillP('prod')" required></select></div>
        <div class="col-md-6"><label>boAt Part Code</label><input type="text" name="partCode" id="prod-p" class="form-control bg-light" readonly></div>
        <div class="col-md-6"><label>FG Output</label><input type="number" name="fgQty" class="form-control" required></div>
      </div>
      <button class="btn btn-primary mt-3 w-100">Save Production</button>
    </form>
  </div>

  <!-- 2. PDI -->
  <div id="pdi" class="tab-pane hidden">
    <form onsubmit="saveData(event, 'PDI')">
      <div class="row g-3">
        <div class="col-md-3"><label>Date</label><input type="date" name="date" class="form-control" required></div>
        <div class="col-md-3"><label>Line</label><input type="number" name="line" class="form-control" min="1" max="24" oninput="checkFloor(this, 'bdg-d')" required><span id="bdg-d" class="floor-badge hidden"></span></div>
        <div class="col-md-3"><label>Model</label><select name="model" id="pdi-m" class="form-select" onchange="filterC('pdi')" required></select></div>
        <div class="col-md-3"><label>Color</label><select name="color" id="pdi-c" class="form-select" onchange="fillP('pdi')" required></select></div>
        <div class="col-md-4"><label>Part Code</label><input type="text" name="partCode" id="pdi-p" class="form-control bg-light" readonly></div>
        <div class="col-md-4"><label>Lot ID</label><input type="text" name="lotId" class="form-control"></div>
        <div class="col-md-4"><label>Lot Type</label><select name="lotType" class="form-select"><option>Fresh</option><option>Rework</option><option>Warranty</option><option>Old FG</option><option>Market Return</option></select></div>
        <div class="col-md-4"><label>Offer</label><input type="number" id="off" name="pdiOffer" class="form-control" oninput="calcP()" required></div>
        <div class="col-md-4"><label>Pass</label><input type="number" id="pas" name="pdiPass" class="form-control" oninput="calcP()" required></div>
        <div class="col-md-4"><label>Fail</label><input type="text" id="fal" class="form-control" readonly></div>
        <div id="defBox" class="col-12 hidden"><div class="alert alert-danger"><label>Reason:</label><input type="text" name="defectReason" class="form-control"></div></div>
      </div>
      <button class="btn btn-warning mt-3 w-100">Save PDI</button>
    </form>
  </div>

  <!-- 3. DISPATCH -->
  <div id="disp" class="tab-pane hidden">
    <form onsubmit="saveData(event, 'Dispatch')">
      <div class="row g-3">
        <div class="col-md-3"><label>Date</label><input type="date" name="date" class="form-control" required></div>
        <div class="col-md-3"><label>Model</label><select name="model" id="disp-m" class="form-select" onchange="filterC('disp')" required></select></div>
        <div class="col-md-3"><label>Color</label><select name="color" id="disp-c" class="form-select" onchange="fillP('disp')" required></select></div>
        <div class="col-md-3"><label>Part Code</label><input type="text" name="partCode" id="disp-p" class="form-control bg-light" readonly></div>
        <div class="col-12"><label>Dispatch Qty</label><input type="number" name="dispatchQty" class="form-control" required></div>
      </div>
      <button class="btn btn-success mt-3 w-100">Save Dispatch</button>
    </form>
  </div>

  <!-- 4. OPENING -->
  <div id="open" class="tab-pane hidden">
    <form onsubmit="saveData(event, 'Opening')">
      <div class="row g-3">
        <div class="col-md-4"><label>Month</label><input type="month" name="month" class="form-control" required></div>
        <div class="col-md-4"><label>Type</label><select name="openType" class="form-select" onchange="toggleOp(this.value)"><option value="PDI">PDI Opening</option><option value="Dispatch">Dispatch Opening</option></select></div>
        <div class="col-md-4"><label>Model</label><select name="model" id="open-m" class="form-select" onchange="filterC('open')" required></select></div>
        <div class="col-md-4"><label>Color</label><select name="color" id="open-c" class="form-select" onchange="fillP('open')" required></select></div>
        <div class="col-md-4"><label>Part Code</label><input type="text" name="partCode" id="open-p" class="form-control bg-light" readonly></div>
        
        <div class="grp-pdi col-md-4"><label>Line</label><input type="number" name="line" class="form-control" min="1" max="24"></div>
        <div class="grp-pdi col-md-4"><label>For PDI Open</label><input type="number" name="pdiOpenQty" class="form-control"></div>
        <div class="grp-pdi col-md-4"><label>For Rework Open</label><input type="number" name="reworkOpenQty" class="form-control"></div>
        <div class="grp-pdi col-12"><label>Rework Reason</label><input type="text" name="reworkReason" class="form-control"></div>
        <div class="grp-disp col-12 hidden"><label>Dispatch Opening Qty</label><input type="number" name="dispatchOpenQty" class="form-control"></div>
      </div>
      <button class="btn btn-info mt-3 w-100 text-white">Save Opening</button>
    </form>
  </div>

  <!-- 5. LINE DASHBOARD -->
  <div id="dash1" class="tab-pane hidden">
    <h4>Line Wise Status</h4>
    <div class="input-group mb-3"><input type="number" id="dashLine" class="form-control" placeholder="Line No (1-24)"><button class="btn btn-dark" onclick="renderDash1()">Show</button></div>
    <div id="dash1-res"></div>
  </div>

  <!-- 6. MASTER DASHBOARD -->
  <div id="dash2" class="tab-pane hidden">
    <div class="d-flex justify-content-between"><h4>Master Status</h4><button class="btn btn-sm btn-outline-dark" onclick="renderDash2()">Refresh</button></div>
    <div class="table-responsive mt-2"><table class="table table-bordered table-sm table-striped"><thead class="table-dark"><tr><th>Model</th><th>Color</th><th>Part</th><th>Opn(Disp)</th><th>FG Out</th><th>PDI Pass</th><th>Disp</th><th>Bal(PDI)</th><th>Bal(Disp)</th></tr></thead><tbody id="master-body"></tbody></table></div>
  </div>

</div>

<script>
  // **********************************************
  // PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE
  const SCRIPT_URL = "PASTE_YOUR_WEB_APP_URL_HERE"; 
  // **********************************************

  let masterData = [];
  let dashboardData = {};

  function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

  window.onload = function() {
    toggleLoader(true);
    // Fetch Masters
    fetch(SCRIPT_URL + "?action=getMasters")
      .then(r => r.json())
      .then(d => {
        masterData = d;
        populateModels(['prod','pdi','disp','open']);
        toggleLoader(false);
      })
      .catch(e => { alert("Error connecting to Google Sheet: "+e); toggleLoader(false); });
  };

  // --- TAB UI ---
  function showTab(id) {
    document.querySelectorAll('.tab-pane').forEach(e => e.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
  }

  // --- LOGIC ---
  function checkFloor(inp, id) {
    let v=parseInt(inp.value), el=document.getElementById(id);
    el.className="floor-badge";
    if(v>=1&&v<=8){el.innerText="1st Floor";el.classList.add("bg-f1");}
    else if(v>=9&&v<=16){el.innerText="2nd Floor";el.classList.add("bg-f2");}
    else if(v>=17&&v<=24){el.innerText="Basement";el.classList.add("bg-base");}
    else el.classList.add("hidden");
  }

  function populateModels(ids) {
    let ms = [...new Set(masterData.map(r=>r[1]))].sort();
    ids.forEach(x => {
      let sel = document.getElementById(x+'-m');
      sel.innerHTML = '<option value="">Select Model</option>';
      ms.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
    });
  }

  function filterC(pre) {
    let mod = document.getElementById(pre+'-m').value, cSel = document.getElementById(pre+'-c');
    cSel.innerHTML = '<option value="">Select Color</option>';
    [...new Set(masterData.filter(r=>r[1]==mod).map(r=>r[2]))].sort().forEach(c=>cSel.innerHTML+=`<option value="${c}">${c}</option>`);
    document.getElementById(pre+'-p').value = "";
  }

  function fillP(pre) {
    let m = document.getElementById(pre+'-m').value, c = document.getElementById(pre+'-c').value;
    let f = masterData.find(r=>r[1]==m && r[2]==c);
    if(f) document.getElementById(pre+'-p').value = f[0];
  }

  function calcP() {
    let f = (document.getElementById('off').value||0) - (document.getElementById('pas').value||0);
    document.getElementById('fal').value = f;
    document.getElementById('defBox').classList.toggle('hidden', f<=0);
  }

  function toggleOp(v) {
    document.querySelectorAll('.grp-pdi').forEach(e=>e.classList.toggle('hidden', v!='PDI'));
    document.querySelector('.grp-disp').classList.toggle('hidden', v!='Dispatch');
  }

  // --- SAVE DATA (POST) ---
  function saveData(e, type) {
    e.preventDefault();
    if(SCRIPT_URL.includes("PASTE_YOUR")) return alert("Please update SCRIPT_URL in index.html");
    
    toggleLoader(true);
    let formData = Object.fromEntries(new FormData(e.target));
    
    fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ type: type, formData: formData })
    })
    .then(r => r.json())
    .then(d => {
      toggleLoader(false);
      alert(d.message);
      if(d.status === "success") e.target.reset();
    })
    .catch(err => { toggleLoader(false); alert("Error saving: " + err); });
  }

  // --- DASHBOARDS ---
  function fetchDashData(cb) {
    toggleLoader(true);
    fetch(SCRIPT_URL + "?action=getDashboard")
      .then(r => r.json())
      .then(d => { dashboardData = d; toggleLoader(false); cb(); });
  }

  function renderDash1() {
    let line = document.getElementById('dashLine').value;
    if(!line) return alert("Enter Line No");
    fetchDashData(() => {
       let map = {};
       const k = (m,c,p)=>m+"|"+c+"|"+p;
       // Logic: Production
       dashboardData.prod.filter(r=>r[1]==line).forEach(r=>{
         let key = k(r[3],r[4],r[5]);
         if(!map[key]) map[key]={m:r[3],c:r[4],p:r[5],fg:0,oPdi:0,oRew:0,pass:0,fail:0,rewPass:0,rsn:""};
         map[key].fg += Number(r[6]||0);
       });
       // Opening
       dashboardData.open.filter(r=>r[2]==line && r[1]=='PDI').forEach(r=>{
         let key = k(r[3],r[4],r[5]);
         if(!map[key]) map[key]={m:r[3],c:r[4],p:r[5],fg:0,oPdi:0,oRew:0,pass:0,fail:0,rewPass:0,rsn:r[8]};
         map[key].oPdi += Number(r[6]||0); map[key].oRew += Number(r[7]||0);
       });
       // PDI
       dashboardData.pdi.filter(r=>r[1]==line).forEach(r=>{
         let key = k(r[3],r[4],r[5]);
         if(!map[key]) map[key]={m:r[3],c:r[4],p:r[5],fg:0,oPdi:0,oRew:0,pass:0,fail:0,rewPass:0,rsn:""};
         map[key].pass += Number(r[9]||0); map[key].fail += Number(r[10]||0);
         if(r[11]) map[key].rsn = r[11];
         if(r[7]=='Rework' || r[7]=='Old FG') map[key].rewPass += Number(r[9]||0);
       });

       let h='<table class="table table-bordered"><thead><tr><th>Model</th><th>Color</th><th>Open PDI</th><th>FG Out</th><th>Pass</th><th>Bal PDI</th><th>For Rework</th><th>Reason</th></tr></thead><tbody>';
       for(let x in map){
         let o=map[x];
         let bPdi = (o.oPdi + o.fg) - o.pass;
         let bRew = o.oRew + o.fail - o.rewPass;
         h+=`<tr><td>${o.m}</td><td>${o.c}</td><td>${o.oPdi}</td><td>${o.fg}</td><td>${o.pass}</td><td class="bg-light fw-bold">${bPdi}</td><td class="text-danger fw-bold">${bRew}</td><td>${bRew>0?o.rsn:''}</td></tr>`;
       }
       document.getElementById('dash1-res').innerHTML = h+'</tbody></table>';
    });
  }

  function renderDash2() {
    fetchDashData(() => {
       let map = {};
       const get = (m,c,p) => { let k=m+c; if(!map[k]) map[k]={m,c,p,od:0,fg:0,pass:0,disp:0}; return map[k]; };
       dashboardData.open.filter(r=>r[1]=='Dispatch').forEach(r=>get(r[3],r[4],r[5]).od+=Number(r[9]||0));
       dashboardData.prod.forEach(r=>get(r[3],r[4],r[5]).fg+=Number(r[6]||0));
       dashboardData.pdi.forEach(r=>get(r[3],r[4],r[5]).pass+=Number(r[9]||0));
       dashboardData.disp.forEach(r=>get(r[1],r[2],r[3]).disp+=Number(r[4]||0));

       let h='';
       for(let k in map){
         let o=map[k];
         let bPdi = o.fg - o.pass;
         let bDsp = (o.od + o.pass) - o.disp;
         h+=`<tr><td>${o.m}</td><td>${o.c}</td><td>${o.p}</td><td>${o.od}</td><td>${o.fg}</td><td>${o.pass}</td><td>${o.disp}</td><td>${bPdi}</td><td>${bDsp}</td></tr>`;
       }
       document.getElementById('master-body').innerHTML = h;
    });
  }
</script>

</body>
</html>